<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="/paginas/perfil/perfil.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="/paginas/perfil/img.js"></script>

    <title>Perfil do Usuário</title>

</head>
<body>
    <div class="profile-container">
        <div class="profile-header">
            <div class="profile-header-top">
              <div style="display: flex; justify-content: center;">
                <h1>Bem-vindo ao seu perfil!</h1>
              </div>
                <div class="home-link">
                  <a href="/">
                      <i class="fas fa-home"></i>Home
                  </a>
              </div>
            </div>
            <hr>
            <img id="profile-picture" src="" alt="Foto de Perfil">
            <h1 id="user-name"></h1>
            <p id="user-email"></p>
        </div>
        <div id="user-info">
        <!-- As informações do usuário serão carregadas aqui -->
        </div>
        <ul class="profile-details">
            <li><strong>Preferências de Leitura:</strong> <span id="user-preferences"></span></li>
        </ul>
        <div class="preferences-section">
          <h2>Editar Preferências de Leitura</h2>
          <p>Separe as preferências por vírgulas. Use aspas para títulos compostos.</p>
          <textarea id="preferences-input" rows="4" placeholder='Exemplo: "My Hero Academia", "Attack on Titan", "One Piece", Naruto, Jujutsu'></textarea>
          <button id="save-preferences-btn">Salvar Preferências</button>
        </div>
      
        <!-- Os mangás serão exibidos aqui -->
        <h2 class="mt-5">Meus Mangás</h2>
        <div id="user-mangas" class="row">
        </div>
    </div>

    <script>
      // Função para carregar as preferências do usuário
async function loadUserPreferences() {
    const userId = sessionStorage.getItem("usuarioId");

    try {
        const response = await fetch(`http://localhost:3000/usuarios/perfil/${userId}`);
        const user = await response.json();

        if (response.ok) {
            // Carrega as preferências no textarea
            document.getElementById("preferences-input").value = user.preferencias_leitura || "";
        } else {
            alert(user.message || "Erro ao carregar preferências do usuário");
        }
    } catch (error) {
        console.error("Erro ao carregar preferências do usuário", error);
        alert("Erro ao conectar com o servidor");
    }
}

// Função para salvar as preferências do usuário
async function saveUserPreferences() {
    const userId = sessionStorage.getItem("usuarioId");
    const preferencias = document.getElementById("preferences-input").value;

    try {
        const response = await fetch(`http://localhost:3000/usuarios/perfil/${userId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ preferencias_leitura: preferencias })
        });

        const result = await response.json();

        if (response.ok) {
            alert("Preferências atualizadas com sucesso!");
            // Atualiza o campo de preferências exibido
            document.getElementById("user-preferences").textContent = preferencias;
        } else {
            alert(result.message || "Erro ao atualizar preferências");
        }
    } catch (error) {
        console.error("Erro ao atualizar preferências", error);
        alert("Erro ao conectar com o servidor");
    }
}

// Adiciona evento ao botão de salvar preferências
document.getElementById("save-preferences-btn").addEventListener('click', saveUserPreferences);
    </script>

    <!-- Script para carregar informações do perfil do usuário -->
    <script>
      async function loadUserProfile() {
        const userId = sessionStorage.getItem("usuarioId");
        
        if (!userId) {
          alert("Usuário não está logado");
          window.location.href = "/login";
          return;
        }
        
        try {
          const response = await fetch(`http://localhost:3000/usuarios/perfil/${userId}`);
          const user = await response.json();

          if (response.ok) {
            document.getElementById("user-name").textContent = user.nome;
            document.getElementById("user-email").textContent = user.email;
            document.getElementById("profile-picture").src = user.foto_perfil || getRandomImage();
            document.getElementById("user-preferences").textContent = user.preferencias_leitura || "Não especificado";
          } else {
            alert(user.message || "Erro ao carregar perfil do usuário");
          }
        } catch (error) {
          console.error("Erro ao carregar perfil do usuário", error);
          alert("Erro ao conectar com o servidor");
        }
      }

      // Chama a função para carregar as informações do usuário
      window.onload = loadUserProfile;
    </script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const userId = sessionStorage.getItem('usuarioId');
        if (!userId) {
          alert('Você precisa estar logado para ver esta página.');
          window.location.href = '/login';
          return;
        }

        // Buscar informações do usuário
        fetch(`/usuarios/perfil/${userId}`)
          .then(response => response.json())
          .then(data => {
            const userInfoDiv = document.getElementById('user-info');
            userInfoDiv.innerHTML = `
              <p><strong>Nome:</strong> ${data.nome}</p>
              <p><strong>Email:</strong> ${data.email}</p>
            `;
          })
          .catch(error => {
            console.error('Erro ao obter informações do usuário:', error);
            alert('Erro ao obter informações do usuário');
          });

        // Buscar os mangás do usuário
        fetch(`/usuarios/${userId}/mangas`)
          .then(response => response.json())
          .then(data => {
            const mangaIds = data.mangaIds;
            if (mangaIds.length === 0) {
              document.getElementById('user-mangas').innerHTML = '<p>Você ainda não adicionou nenhum mangá.</p>';
              return;
            }

            // Para cada mangaId, buscar detalhes na API e exibir
            mangaIds.forEach(mangaId => {
              fetch(`https://api.jikan.moe/v4/manga/${mangaId}`)
                .then(response => response.json())
                .then(data => {
                  const manga = data.data;
                  displayManga(manga);
                })
                .catch(error => {
                  console.error('Erro ao obter detalhes do mangá:', error);
                });
            });
          })
          .catch(error => {
            console.error('Erro ao obter mangás do usuário:', error);
            alert('Erro ao obter mangás do usuário');
          });

        function displayManga(manga) {
          const userMangasDiv = document.getElementById('user-mangas');
          const mangaCard = document.createElement('div');
          mangaCard.classList.add('col-md-4', 'card');

          const truncatedSynopsis = truncateSynopsis(manga.synopsis);

          mangaCard.innerHTML = `
            <div class="card mb-4 shadow-sm">
              <img src="${manga.images.jpg.image_url}" class="card-img-top" alt="${manga.title}">
              <div class="card-body">
                <h5 class="card-title">${manga.title}</h5>
                <p class="card-text">${truncatedSynopsis}</p>
              </div>
            </div>
          `;

          userMangasDiv.appendChild(mangaCard);
        }

        function truncateSynopsis(synopsis) {
          if (!synopsis) {
            return "Descrição não disponível";
          }

          const maxLength = 150; // Definir o limite de caracteres

          if (synopsis.length <= maxLength) {
            return synopsis;
          }

          const periodIndex = synopsis.indexOf(".", maxLength);
          if (periodIndex !== -1 && periodIndex <= maxLength + 50) {
            return synopsis.substring(0, periodIndex + 1);
          }

          return synopsis.substring(0, maxLength) + "...";
        }
      });
    </script>

<script>
  async function loadUserProfile() {
    const userId = sessionStorage.getItem("usuarioId");
    const isAdmin = sessionStorage.getItem("isAdmin") === 'true';

    if (!userId) {
      alert("Usuário não está logado");
      window.location.href = "/login";
      return;
    }

    try {
      const response = await fetch(`http://localhost:3000/usuarios/perfil/${userId}`);
      const user = await response.json();

      if (response.ok) {
        document.getElementById("user-name").textContent = user.nome;
        document.getElementById("user-email").textContent = user.email;
        document.getElementById("profile-picture").src = user.foto_perfil || getRandomImage();
        document.getElementById("user-preferences").textContent = user.preferencias_leitura || "Não especificado";

        // Se o usuário for administrador, carrega a seção de admin
        if (isAdmin) {
          loadAdminSection();
        }
      } else {
        alert(user.message || "Erro ao carregar perfil do usuário");
      }
    } catch (error) {
      console.error("Erro ao carregar perfil do usuário", error);
      alert("Erro ao conectar com o servidor");
    }
  }

  // Função para carregar a seção de administração
  async function loadAdminSection() {
    try {
      const isAdmin = sessionStorage.getItem("isAdmin") === 'true';
      if (!isAdmin) return;

      const response = await fetch("http://localhost:3000/usuarios/admin/usuarios", {
        headers: {
          'isadmin': 'true' // Envia o header para indicar que é administrador
        }
      });
      const users = await response.json();

      if (response.ok) {
        const adminSection = document.createElement('div');
        adminSection.setAttribute('id', 'admin-section');
        adminSection.innerHTML = `
          <h2 class="admin-title"><strong>Administração:</strong></h2>
          <ul class="admin-list">
            ${users.map(user => `
              <li>
                <strong>Nome:</strong> ${user.nome} |
                <br>
                <strong>Email:</strong> ${user.email} |
                <br>
                <strong>Preferências:</strong> ${user.preferencias_leitura || 'N/A'}
                <br>
                <button class="delete-user-btn" data-user-id="${user.id}">Deletar</button>
              </li>
            `).join('')}
          </ul>
        `;

        document.querySelector('.profile-container').appendChild(adminSection);

        // Adicionar eventos aos botões de deletar
        document.querySelectorAll('.delete-user-btn').forEach(button => {
          button.addEventListener('click', async (event) => {
            const userIdToDelete = event.target.getAttribute('data-user-id');

            if (confirm('Tem certeza que deseja deletar este usuário?')) {
              try {
                const deleteResponse = await fetch(`http://localhost:3000/usuarios/admin/usuarios/${userIdToDelete}`, {
                  method: 'DELETE',
                  headers: {
                    'Content-Type': 'application/json',
                    'isadmin': 'true'
                  }
                });

                const result = await deleteResponse.json();

                if (deleteResponse.ok) {
                  alert(result.message);
                  // Recarrega a página após o usuário clicar em "OK" no alerta
                  window.location.reload();
                } else {
                  alert(result.message || 'Erro ao deletar usuário');
                }
              } catch (error) {
                console.error('Erro ao deletar usuário', error);
                alert('Erro ao deletar usuário');
              }
            }
          });
        });
      } else {
        alert(users.message || "Erro ao carregar informações de administração");
      }
    } catch (error) {
      console.error("Erro ao carregar informações de administração", error);
      alert("Erro ao carregar informações de administração");
    }
  }
  

  // Chama a função para carregar as informações do usuário
  window.onload = loadUserProfile;
  // Chama a função para carregar as preferências ao carregar a página
  window.onload = function() {
    loadUserProfile();
    loadUserPreferences();
};
</script>
</body>
</html>
